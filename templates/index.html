<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Trading Galáctico - Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card h3 {
            font-size: 2rem;
            margin: 0;
            font-weight: bold;
        }
        
        .stats-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: #667eea;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }
        
        .btn-success:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="text-center mb-5">
                <h1 class="display-4 text-primary">
                    <i class="fas fa-chart-line me-3"></i>
                    <span id="mainTitle">Análisis de Trading Galáctico</span>
                </h1>
                <p class="lead text-muted" id="mainDescription">Sube tu archivo CSV de operaciones o finanzas y obtén análisis detallados con gráficos</p>
            </div>

            <!-- Área de subida de archivos -->
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <h4>Arrastra tu archivo CSV aquí o haz clic para seleccionar</h4>
                <p class="text-muted">Formatos soportados: CSV de posiciones cerradas o CSV de finanzas</p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                <button class="btn btn-upload mt-3" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload me-2"></i>Seleccionar Archivo
                </button>
            </div>

            <!-- Mensajes de estado -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Procesando archivo...</p>
            </div>

            <!-- Resultados del análisis -->
            <div id="results" style="display: none;">
                <!-- Botón de descarga PDF -->
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <button class="btn btn-success btn-lg" id="downloadPdfBtn" onclick="downloadPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Descargar Análisis en PDF
                        </button>
                    </div>
                </div>
                
                <!-- Resumen de métricas -->
                <div class="row" id="summaryStats"></div>

                <!-- Gráficos -->
                <div class="row" id="chartsContainer">
                    <!-- Los gráficos se cargarán dinámicamente según el tipo de archivo -->
                </div>

                <!-- Tablas de datos -->
                <div class="row" id="tablesContainer">
                    <!-- Las tablas se cargarán dinámicamente según el tipo de archivo -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let currentData = null;

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFileInput();
        });

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }

        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('Por favor, selecciona un archivo CSV válido.');
                return;
            }

            uploadFile(file);
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            showLoading(true);
            hideMessages();

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.error) {
                    showError(data.error);
                } else {
                    showSuccess('Archivo procesado correctamente. Mostrando análisis...');
                    currentData = data;
                    displayResults(data);
                }
            })
            .catch(error => {
                showLoading(false);
                showError('Error al procesar el archivo: ' + error.message);
            });
        }

        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            // Detectar tipo de archivo y actualizar título
            const fileType = data.file_type || 'trading';
            updatePageTitle(fileType);
            
            // Mostrar resumen
            displaySummary(data.summary, fileType);
            
            // Mostrar tablas primero
            displayTables(data, fileType);
            
            // Mostrar gráficos después
            displayCharts(data.charts, fileType);
        }

        function updatePageTitle(fileType) {
            const titleElement = document.getElementById('mainTitle');
            const descriptionElement = document.getElementById('mainDescription');
            
            if (fileType === 'finance') {
                titleElement.textContent = 'Análisis Financiero Galáctico';
                descriptionElement.textContent = 'Análisis de transacciones financieras con gráficos y estadísticas detalladas';
            } else {
                titleElement.textContent = 'Análisis de Trading Galáctico';
                descriptionElement.textContent = 'Análisis de operaciones de trading con gráficos y estadísticas detalladas';
            }
        }

        function displaySummary(summary, fileType) {
            let summaryHtml = '';
            
            if (fileType === 'finance') {
                summaryHtml = `
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h3>${summary.deposit_transactions}</h3>
                            <p>Depósitos</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h3>$${summary.total_amount.toLocaleString()}</h3>
                            <p>Monto Total</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <h3>$${summary.avg_transaction.toLocaleString()}</h3>
                            <p>Promedio por Transacción</p>
                        </div>
                    </div>
                `;
            } else {
                summaryHtml = `
                    <div class="col-md-2">
                        <div class="stats-card">
                            <h3>${summary.total_operations}</h3>
                            <p>Total Operaciones</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stats-card">
                            <h3>$${summary.total_profit.toLocaleString()}</h3>
                            <p>Ganancia/Pérdida Total</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stats-card">
                            <h3>$${summary.total_swap.toLocaleString()}</h3>
                            <p>Coste Total Swap</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stats-card">
                            <h3>${summary.winning_trades}</h3>
                            <p>Operaciones Ganadoras</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stats-card">
                            <h3>${summary.losing_trades}</h3>
                            <p>Operaciones Perdedoras</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stats-card">
                            <h3>${summary.win_rate}%</h3>
                            <p>Porcentaje de Éxito</p>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('summaryStats').innerHTML = summaryHtml;
        }

        function displayCharts(charts, fileType) {
            const chartsContainer = document.getElementById('chartsContainer');
            chartsContainer.innerHTML = '';
            
            if (fileType === 'finance') {
                // Gráfico de evolución temporal
                if (charts.evolution) {
                    const evolutionDiv = document.createElement('div');
                    evolutionDiv.className = 'col-lg-12';
                    evolutionDiv.innerHTML = `
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-line me-2"></i>Evolución del Monto Acumulado</h5>
                            <div id="evolutionChart"></div>
                        </div>
                    `;
                    chartsContainer.appendChild(evolutionDiv);
                    Plotly.newPlot('evolutionChart', charts.evolution.data, charts.evolution.layout);
                }
            } else {
                // Gráfico de instrumentos
                if (charts.instrument) {
                    const instrumentDiv = document.createElement('div');
                    instrumentDiv.className = 'col-lg-6';
                    instrumentDiv.innerHTML = `
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-bar me-2"></i>Ganancia/Pérdida por Instrumento</h5>
                            <div id="instrumentChart"></div>
                        </div>
                    `;
                    chartsContainer.appendChild(instrumentDiv);
                    Plotly.newPlot('instrumentChart', charts.instrument.data, charts.instrument.layout);
                }
                
                // Gráfico de evolución temporal
                if (charts.evolution) {
                    const evolutionDiv = document.createElement('div');
                    evolutionDiv.className = 'col-lg-6';
                    evolutionDiv.innerHTML = `
                        <div class="chart-container">
                            <h5><i class="fas fa-chart-line me-2"></i>Evolución Temporal</h5>
                            <div id="evolutionChart"></div>
                        </div>
                    `;
                    chartsContainer.appendChild(evolutionDiv);
                    Plotly.newPlot('evolutionChart', charts.evolution.data, charts.evolution.layout);
                }
            }
        }

        function displayTables(data, fileType) {
            const tablesContainer = document.getElementById('tablesContainer');
            tablesContainer.innerHTML = '';
            
            // Tabla mensual
            const monthlyDiv = document.createElement('div');
            monthlyDiv.className = fileType === 'finance' ? 'col-lg-12' : 'col-lg-6';
            
            if (fileType === 'finance') {
                monthlyDiv.innerHTML = `
                    <div class="table-container">
                        <h5><i class="fas fa-table me-2"></i>Estadísticas por Mes</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="monthlyTable">
                                <thead>
                                    <tr>
                                        <th>Mes</th>
                                        <th>Monto Total</th>
                                        <th>Transacciones</th>
                                        <th>Promedio</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                monthlyDiv.innerHTML = `
                    <div class="table-container">
                        <h5><i class="fas fa-table me-2"></i>Estadísticas por Mes</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="monthlyTable">
                                <thead>
                                    <tr>
                                        <th>Mes</th>
                                        <th>Ganancia/Pérdida Total</th>
                                        <th>Operaciones</th>
                                        <th>Promedio</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            tablesContainer.appendChild(monthlyDiv);
            
            // Solo mostrar tabla de instrumentos para archivos de trading
            if (fileType !== 'finance') {
                const typeDiv = document.createElement('div');
                typeDiv.className = 'col-lg-6';
                
                typeDiv.innerHTML = `
                    <div class="table-container">
                        <h5><i class="fas fa-table me-2"></i>Estadísticas por Instrumento</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="instrumentTable">
                                <thead>
                                    <tr>
                                        <th>Instrumento</th>
                                        <th>Ganancia/Pérdida Total</th>
                                        <th>Operaciones</th>
                                        <th>Promedio</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                tablesContainer.appendChild(typeDiv);
            }
            
            // Llenar tabla mensual
            const monthlyTable = document.getElementById('monthlyTable').getElementsByTagName('tbody')[0];
            monthlyTable.innerHTML = '';
            
            data.monthly_stats.forEach(row => {
                const tr = document.createElement('tr');
                if (fileType === 'finance') {
                    tr.innerHTML = `
                        <td>${row.Mes}</td>
                        <td>$${row['Monto Total'].toLocaleString()}</td>
                        <td>${row['Número Transacciones']}</td>
                        <td>$${row['Monto Promedio'].toLocaleString()}</td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${row.Mes}</td>
                        <td>$${row['Ganancia/Pérdida Total'].toLocaleString()}</td>
                        <td>${row['Número Operaciones']}</td>
                        <td>$${row['Ganancia/Pérdida Promedio'].toLocaleString()}</td>
                    `;
                }
                monthlyTable.appendChild(tr);
            });
            
            // Agregar fila de totales para archivos de finanzas
            if (fileType === 'finance') {
                const totalRow = document.createElement('tr');
                totalRow.className = 'table-warning fw-bold';
                
                // Calcular totales
                const totalAmount = data.monthly_stats.reduce((sum, row) => sum + row['Monto Total'], 0);
                const totalTransactions = data.monthly_stats.reduce((sum, row) => sum + row['Número Transacciones'], 0);
                const avgAmount = totalTransactions > 0 ? totalAmount / totalTransactions : 0;
                
                totalRow.innerHTML = `
                    <td>TOTAL</td>
                    <td>$${totalAmount.toLocaleString()}</td>
                    <td>${totalTransactions}</td>
                    <td>$${avgAmount.toLocaleString()}</td>
                `;
                monthlyTable.appendChild(totalRow);
            }

            // Solo llenar tabla de instrumentos para archivos de trading
            if (fileType !== 'finance' && data.instrument_stats) {
                const typeTable = document.getElementById('instrumentTable').getElementsByTagName('tbody')[0];
                typeTable.innerHTML = '';
                
                const statsData = data.instrument_stats;
                const keyField = 'Instrumentos';
                const totalField = 'Ganancia/Pérdida Total';
                const countField = 'Número Operaciones';
                const avgField = 'Ganancia/Pérdida Promedio';
                
                statsData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // Si es la última fila (TOTAL), aplicar estilo destacado
                    if (row[keyField] === 'TOTAL') {
                        tr.className = 'table-warning fw-bold';
                    }
                    
                    tr.innerHTML = `
                        <td>${row[keyField]}</td>
                        <td>$${row[totalField].toLocaleString()}</td>
                        <td>${row[countField]}</td>
                        <td>$${row[avgField].toLocaleString()}</td>
                    `;
                    typeTable.appendChild(tr);
                });
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function downloadPDF() {
            if (!currentData) {
                showError('No hay datos para generar el PDF. Por favor, sube un archivo CSV primero.');
                return;
            }

            const downloadBtn = document.getElementById('downloadPdfBtn');
            const originalText = downloadBtn.innerHTML;
            
            // Mostrar estado de carga
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando PDF...';

            fetch('/generate_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al generar el PDF');
                }
                return response.blob();
            })
            .then(blob => {
                // Crear enlace de descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `trading_analysis_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('PDF generado y descargado correctamente.');
            })
            .catch(error => {
                showError('Error al generar el PDF: ' + error.message);
            })
            .finally(() => {
                // Restaurar botón
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = originalText;
            });
        }
    </script>
</body>
</html>

